// RUN: %target-sil-opt -copy-propagation -enable-sil-verify-all %s | %FileCheck %s --check-prefixes=CHECK,CHECK-OPT

class X {}

enum FakeOptional<T> {
    case some(T)
    case none
}

sil [ossa] @getX : $@convention(thin) () -> (@owned X)
sil [ossa] @holdX : $@convention(thin) (@guaranteed X) -> ()

// CHECK-LABEL: sil [ossa] @nohoist_destroy_over_reborrow_endborrow : {{.*}} {
// CHECK:       {{bb[0-9]+}}([[REBORROW:%[^,]+]] : @guaranteed $X, [[VALUE:%[^,]+]] : @owned $X):
// CHECK:         end_borrow [[REBORROW]]
// CHECK:         destroy_value [[VALUE]]
// CHECK-LABEL: } // end sil function 'nohoist_destroy_over_reborrow_endborrow'
sil [ossa] @nohoist_destroy_over_reborrow_endborrow : $@convention(thin) () -> () {
entry:
  %get = function_ref @getX : $@convention(thin) () -> @owned X
  %value_1 = apply %get() : $@convention(thin) () -> @owned X
  %lifetime = begin_borrow %value_1 : $X
  br body(%lifetime : $X, %value_1 : $X)

body(%reborrow : @guaranteed $X, %value_2 : @owned $X):
  // TODO: The copy is currently needed to trigger canonicalization of the
  // lifetime.  Remove once it is no longer needed.
  %copy = copy_value %value_2 : $X
  destroy_value %copy : $X

  end_borrow %reborrow : $X
  destroy_value %value_2 : $X
  br exit

exit:
  %retval = tuple ()
  return %retval : $()
}

// CHECK-LABEL: sil [ossa] @hoist_destroy_over_unrelated_endborrow : {{.*}} {
// CHECK:       {{bb[0-9]+}}([[UNRELATED:%[^,]+]] : @guaranteed $X, [[VALUE:%[^,]+]] : @owned $X):
// CHECK:         destroy_value [[VALUE]]
// CHECK:         end_borrow [[UNRELATED]]
// CHECK-LABEL: } // end sil function 'hoist_destroy_over_unrelated_endborrow'
sil [ossa] @hoist_destroy_over_unrelated_endborrow : $@convention(thin) (@guaranteed X) -> () {
entry(%unrelated : @guaranteed $X):
  %get = function_ref @getX : $@convention(thin) () -> @owned X
  %value_1 = apply %get() : $@convention(thin) () -> @owned X
  %borrow_1 = begin_borrow %unrelated : $X
  br body(%borrow_1 : $X, %value_1 : $X)

body(%borrow_2 : @guaranteed $X, %value_2 : @owned $X):
  // TODO: The copy is currently needed to trigger canonicalization of the
  // lifetime.  Remove once it is no longer needed.
  %copy = copy_value %value_2 : $X
  destroy_value %copy : $X

  %hold = function_ref @holdX : $@convention(thin) (@guaranteed X) -> ()
  apply %hold(%borrow_2) : $@convention(thin) (@guaranteed X) -> ()
  end_borrow %borrow_2 : $X
  destroy_value %value_2 : $X
  br exit

exit:
  %retval = tuple ()
  return %retval : $()
}

// CHECK-LABEL: sil [ossa] @nohoist_destroy_over_reborrow_reborrow_endborrow : {{.*}} {
// CHECK:       {{bb[0-9]+}}({{%[^,]+}} : @guaranteed $X, {{%[^,]+}} : @owned $X):
// CHECK:       {{bb[0-9]+}}([[REBORROW:%[^,]+]] : @guaranteed $X, [[VALUE:%[^,]+]] : @owned $X):
// CHECK:         end_borrow [[REBORROW]]
// CHECK:         destroy_value [[VALUE]]
// CHECK-LABEL: } // end sil function 'nohoist_destroy_over_reborrow_reborrow_endborrow'
sil [ossa] @nohoist_destroy_over_reborrow_reborrow_endborrow : $@convention(thin) () -> () {
entry:
  %get = function_ref @getX : $@convention(thin) () -> @owned X
  %value_1 = apply %get() : $@convention(thin) () -> @owned X
  %lifetime = begin_borrow %value_1 : $X
  br body1(%lifetime : $X, %value_1 : $X)

body1(%lifetime_2 : @guaranteed $X, %value_2 : @owned $X):
  br body2(%lifetime_2 : $X, %value_2 : $X)

body2(%lifetime_3 : @guaranteed $X, %value_3 : @owned $X):
  // TODO: Remove the copy once it isn't necessary to trigger canonicalization.
  %copy_3 = copy_value %value_3 : $X
  destroy_value %copy_3 : $X

  end_borrow %lifetime_3 : $X
  destroy_value %value_3 : $X
  br exit

exit:
  %14 = tuple ()
  return %14 : $()
}

// CHECK-LABEL: sil [ossa] @hoist_destroy_over_unrelated_reborrow_reborrow_endborrow : {{.*}} {
// CHECK:       {{bb[0-9]+}}({{%[^,]+}} : @guaranteed $X, {{%[^,]+}} : @owned $X):
// CHECK:       {{bb[0-9]+}}([[REBORROW:%[^,]+]] : @guaranteed $X, [[VALUE:%[^,]+]] : @owned $X):
// CHECK:         destroy_value [[VALUE]]
// CHECK:         end_borrow [[REBORROW]]
// CHECK-LABEL: } // end sil function 'hoist_destroy_over_unrelated_reborrow_reborrow_endborrow'
sil [ossa] @hoist_destroy_over_unrelated_reborrow_reborrow_endborrow : $@convention(thin) (@guaranteed X) -> () {
entry(%unrelated : @guaranteed $X):
  %get = function_ref @getX : $@convention(thin) () -> @owned X
  %value_1 = apply %get() : $@convention(thin) () -> @owned X
  %borrow_1 = begin_borrow %unrelated : $X
  br body1(%borrow_1 : $X, %value_1 : $X)

body1(%borrow_2 : @guaranteed $X, %value_2 : @owned $X):
  br body2(%borrow_2 : $X, %value_2 : $X)

body2(%borrow_3 : @guaranteed $X, %value_3 : @owned $X):
  // TODO: Remove the copy once it isn't necessary to trigger canonicalization.
  %copy_3 = copy_value %value_3 : $X
  destroy_value %copy_3 : $X

  %hold = function_ref @holdX : $@convention(thin) (@guaranteed X) -> ()
  apply %hold(%borrow_3) : $@convention(thin) (@guaranteed X) -> ()
  end_borrow %borrow_3 : $X
  destroy_value %value_3 : $X
  br exit

exit:
  %14 = tuple ()
  return %14 : $()
}

// CHECK-LABEL: sil [ossa] @nohoist_destroy_over_forward_reborrow_endborrow : {{.*}} {
// CHECK:       {{bb[0-9]+}}([[REBORROW:%[^,]+]] : @guaranteed $X, [[VALUE:%[^,]+]] : @owned $X):
// CHECK:         end_borrow [[REBORROW]]
// CHECK:         destroy_value [[VALUE]]
// CHECK-LABEL: } // end sil function 'nohoist_destroy_over_forward_reborrow_endborrow'
sil [ossa] @nohoist_destroy_over_forward_reborrow_endborrow : $@convention(thin) () -> () {
entry:
  %get = function_ref @getX : $@convention(thin) () -> @owned X
  %value_1 = apply %get() : $@convention(thin) () -> @owned X
  br body1(%value_1 : $X)

body1(%value_2 : @owned $X):
  %lifetime_2 = begin_borrow %value_2 : $X
  br body2(%lifetime_2 : $X, %value_2 : $X)

body2(%lifetime_3 : @guaranteed $X, %value_3 : @owned $X):
  // TODO: Remove the copy once it isn't necessary to trigger canonicalization.
  %copy_3 = copy_value %value_3 : $X
  destroy_value %copy_3 : $X

  end_borrow %lifetime_3 : $X
  destroy_value %value_3 : $X
  br exit

exit:
  %retval = tuple ()
  return %retval : $()
}

// CHECK-LABEL: sil [ossa] @nohoist_destroy_over_reborrow_loop : {{.*}} {
// CHECK:       {{bb[0-9]+}}([[REBORROW:%[^,]+]] : @guaranteed $FakeOptional<X>, [[VALUE:%[^,]+]] : @owned $FakeOptional<X>):
// CHECK:         cond_br undef, [[LOOP:bb[0-9]+]], [[BODY:bb[0-9]+]]
// CHECK:       [[LOOP]]:
// CHECK:         end_borrow [[REBORROW]] : $FakeOptional<X>
// CHECK:         destroy_value [[VALUE]] : $FakeOptional<X>
// CHECK:       [[BODY]]:
// CHECK:         end_borrow [[REBORROW]] : $FakeOptional<X>
// CHECK:         destroy_value [[VALUE]] : $FakeOptional<X>
// CHECK-LABEL: } // end sil function 'nohoist_destroy_over_reborrow_loop'
sil [ossa] @nohoist_destroy_over_reborrow_loop : $@convention(thin) () -> () {
entry:
  %none1 = enum $FakeOptional<X>, #FakeOptional.none!enumelt
  %none2 = enum $FakeOptional<X>, #FakeOptional.none!enumelt
  br head(%none2 : $FakeOptional<X>, %none1 : $FakeOptional<X>)

head(%reborrow : @guaranteed $FakeOptional<X>, %value : @owned $FakeOptional<X>):
  cond_br undef, body, exit

body:
  %get = function_ref @getX : $@convention(thin) () -> (@owned X)
  %value_0 = apply %get() : $@convention(thin) () -> (@owned X)
  end_borrow %reborrow : $FakeOptional<X>

  // TODO: Remove the copy once it isn't necessary to trigger canonicalization.
  %bogus = copy_value %value : $FakeOptional<X>
  destroy_value %bogus : $FakeOptional<X>

  destroy_value %value : $FakeOptional<X>
  %some_value_0 = enum $FakeOptional<X>, #FakeOptional.some!enumelt, %value_0 : $X
  %some_borrow_0 = begin_borrow %some_value_0 : $FakeOptional<X>
  br head(%some_borrow_0 : $FakeOptional<X>, %some_value_0 : $FakeOptional<X>)

exit:
  %retval = tuple ()
  end_borrow %reborrow : $FakeOptional<X>
  destroy_value %value : $FakeOptional<X>
  return %retval : $()
}
